"use strict";!function(t){angular.module("pw.canvas-painter",[]),function(t){try{t=angular.module("pw.canvas-painter")}catch(e){t=angular.module("pw.canvas-painter",[])}t.run(["$templateCache",function(t){t.put("../templates/canvas.html",'<div class="pwCanvasPaint" style="position:relative"><canvas id="pwCanvasMain"></canvas><canvas id="pwCanvasTmp" style="position:absolute;top:0;left:0"></canvas></div>')}])}(),function(t){try{t=angular.module("pw.canvas-painter")}catch(e){t=angular.module("pw.canvas-painter",[])}t.run(["$templateCache",function(t){t.put("../templates/color-selector.html",'<ul class="pwColorSelector"><li ng-repeat="color in colorList track by $index" class="pwColor" ng-class="{\'active\': (selectedColor === color)}" ng-style="{\'background-color\':color}" ng-click="setColor(color)"></li></ul>')}])}(),angular.module("pw.canvas-painter").directive("pwCanvas",function(){return{restrict:"AE",scope:{options:"=",version:"="},templateUrl:"../templates/canvas.html",link:function(e,n){var a=!!("ontouchstart"in t),o=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1,i=a?"touchstart":"mousedown",r=a?"touchmove":"mousemove",l=a?"touchend":"mouseup",c=e.options;if(c.canvasId=c.customCanvasId||"pwCanvasMain",c.tmpCanvasId=c.customCanvasId?c.canvasId+"Tmp":"pwCanvasTmp",c.width=c.width||400,c.height=c.height||300,c.backgroundColor=c.backgroundColor||"#fff",c.color=c.color||"#000",c.undoEnabled=c.undoEnabled||!1,c.opacity=c.opacity||.9,c.lineWidth=c.lineWidth||1,c.undo=c.undo||!1,c.imageSrc=c.imageSrc||!1,c.imageSrc){var s=new Image;s.onload=function(){h.drawImage(this,0,0)},s.src=c.imageSrc}if(c.undo){var u=[];e.$watch(function(){return u.length},function(t){e.version=t}),e.$watch("version",function(t){return 0>t?(e.version=0,void 0):t>=u.length?(e.version=u.length,void 0):(x(t),void 0)})}var d=document.createElement("canvas");d.id=c.canvasId;var p=document.createElement("canvas");p.id=c.tmpCanvasId,angular.element(p).css({position:"absolute",top:0,left:0}),n.find("div").append(d),n.find("div").append(p);var h=d.getContext("2d"),v=p.getContext("2d"),f={x:0,y:0},g=[];d.width=p.width=c.width,d.height=p.height=c.height,h.fillStyle=c.backgroundColor,h.fillRect(0,0,d.width,d.height),v.globalAlpha=c.opacity,v.lineJoin=v.lineCap="round",v.lineWidth=10,v.strokeStyle=c.color,e.$watch("options.lineWidth",function(t){"string"==typeof t&&(t=parseInt(t,10)),t&&"number"==typeof t&&(v.lineWidth=c.lineWidth=t)}),e.$watch("options.color",function(t){t&&(v.strokeStyle=v.fillStyle=t)}),e.$watch("options.opacity",function(t){t&&(v.globalAlpha=t)});var m=function(t,e){a?o?(t.x=e.layerX,t.y=e.layerY):(t.x=e.changedTouches[0].clientX-e.target.offsetParent.offsetLeft,t.y=e.changedTouches[0].clientY-e.target.offsetParent.offsetTop):(t.x=void 0!==e.offsetX?e.offsetX:e.layerX,t.y=void 0!==e.offsetY?e.offsetY:e.layerY)},y=function(t){if(t&&(t.preventDefault(),m(f,t)),g.push({x:f.x,y:f.y}),3===g.length){var e=g[0];return v.beginPath(),v.arc(e.x,e.y,v.lineWidth/2,0,2*Math.PI,!0),v.fill(),v.closePath(),void 0}v.clearRect(0,0,p.width,p.height),v.beginPath(),v.moveTo(g[0].x,g[0].y);for(var n=1;n<g.length-2;n++){var a=(g[n].x+g[n+1].x)/2,o=(g[n].y+g[n+1].y)/2;v.quadraticCurveTo(g[n].x,g[n].y,a,o)}v.quadraticCurveTo(g[n].x,g[n].y,g[n+1].x,g[n+1].y),v.stroke()},w=function(){c.undo&&e.$apply(function(){u.push(h.getImageData(0,0,p.width,p.height)),angular.isNumber(c.undo)&&c.undo>0&&(u=u.slice(-1*c.undo))}),p.removeEventListener(r,y,!1),h.drawImage(p,0,0),v.clearRect(0,0,p.width,p.height),g=[]},C=function(){p.addEventListener(i,function(t){t.preventDefault(),p.addEventListener(r,y,!1),m(f,t),g.push({x:f.x,y:f.y}),g.push({x:f.x,y:f.y}),y()},!1),p.addEventListener(l,w,!1)};C();var x=function(t){u.length>0&&(h.putImageData(u[t],0,0),u=u.slice(0,t))}}}}),angular.module("pw.canvas-painter").directive("pwColorSelector",function(){return{restrict:"AE",scope:{colorList:"=pwColorSelector",selectedColor:"=color"},templateUrl:"../templates/color-selector.html",link:function(t){t.setColor=function(e){t.selectedColor=e}}}})}(this);